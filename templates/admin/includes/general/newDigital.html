{% extends 'base.html' %} {% block content %}{% load static %}
<div class="heading-container product text-center my-5">
  <h3 class="heading">New Digital Product</h3>
</div>

<div class="stepform">
  <div class="steps-container d-none d-md-flex justify-content-md-center mb-5">
    <div class="step active">
      <div class="text">
        <span class="number">1</span>
        <span class="title">Product Info</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">2</span>
        <span class="title">Ad Sizes Setup</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">3</span>
        <span class="title">Review</span>
      </div>
    </div>
  </div>
  <form id="digital-product-form" action="{% url 'newDigital' %}" method="POST">
    {% csrf_token %}
    <div class="tab">
      <div class="row">
        <div class="col-md-12 col-lg-6">
          <div class="form-group mb-4">
            <label for="product-mag" class="aster">Digital Product Name:</label>
            <input type="text" id="product-mag" name="product-mag" class="form-control" required />
          </div>

          <div class="row mb-4">
            <div class="col-md-12 col-lg-6">
              <div class="form-group">
                <label for="format" class="aster">Select Format:</label>
                <select name="format" id="format" class="form-control" required>
                  <option>Select</option>
                  <option value="jpg">jpg</option>
                  <option value="png">png</option>
                  <option value="gif">gif</option>
                  <option value="mp4">mp4</option>
                </select>
              </div>
            </div>

            <div class="col-md-12 col-lg-6">
              <div class="form-group">
                <label for="ad-type" class="aster">Ad Type:</label>
                <select id="ad-type" name="ad-type" class="form-control" required>
                  <option>Select</option>
                  {% for adtype in adTypes %}
                  <option value="{{adtype.id}}">{{adtype.name}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 col-lg-6">
              <div class="form-group">
                <label for="height" class="aster">Height:</label>
                <input type="number" id="height" class="form-control" required />
              </div>
            </div>

            <div class="col-md-12 col-lg-6">
              <div class="form-group">
                <label for="width" class="aster">Width</label>
                <input type="number" id="width" class="form-control" required />
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-6 d-flex align-items-center">
          <img class="img-fluid" src="{% static 'img/magazine-img.png' %}" alt="magazine-img" />
        </div>
      </div>

      <div class="btn-container d-flex justify-content-end mt-5">
        <button class="btn btn-secondary step-next" type="button">Next <i class="fa fa-solid fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Ad Sizes Setup -->
    <div class="tab">
      <div class="row">
        <div class="col-md-12 col-lg-4">
          <div class="border border-dark rounded p-3">
            <div class="heading-container border-bottom border-dark text-center mb-4">
              <h3 class="color-secondary mb-0">New Standard Ad Size</h3>
            </div>

            <div class="standard-size-container">
              <div class="form-group px-3 mb-3">
                <label for="size-description">Size Description</label>
                <input type="text" id="size-description" class="form-control" />
              </div>

              <div class="form-group px-3 mb-4">
                <div class="row">
                  <div class="col-md-6">
                    <label for="column-num">No. of Columns</label>
                    <input type="text" id="column-num" class="form-control" />
                  </div>
                  <div class="col-md-6">
                    <label for="standardsize-height">Height</label>
                    <input type="text" id="standardsize-height" class="form-control" />
                  </div>
                </div>
              </div>

              <div class="btn-container text-center w-50 mx-auto">
                <button type="button" id="create-standardsize-btn" class="btn btn-secondary w-100">Create</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-12 col-lg-8">
          <div class="p-3">
            <div class="heading-container border-bottom border-dark text-center mb-4">
              <h3 class="color-secondary mb-0">Available Standard Ad Sizes</h3>
            </div>

            <div id="standardsize-table-body" class="table-container">
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Description</th>
                    <th scope="col">No. of Columns</th>
                    <th scope="col">Height</th>
                    <th scope="col">Total Column In.</th>
                    <th scope="col">Status</th>
                    <th scope="col">Select</th>
                  </tr>
                </thead>
                <tbody id="sizes-table-body">
                  {% for size in standardsizes_page_obj %}
                  <tr>
                    <td>{{size.id}}</td>
                    <td>{{size.description}}</td>
                    <td>{{size.columns}}</td>
                    <td>{{size.height}}</td>
                    <td>{{ size.total_columns_in }}</td>
                    <td>
                      <span class="text-capitalize">{{ size.status }}</span>
                    </td>
                    <td>
                      <input type="checkbox" name="sizes" value="{{ size.id }}" />
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="btn-container d-flex justify-content-between mt-5">
        <button class="btn btn-gray step-prev" type="button"><i class="fa fa-solid fa-arrow-left"></i> Previous</button>

        <button class="btn btn-secondary step-next" type="button">Next <i class="fa fa-solid fa-arrow-right"></i></button>
      </div>
    </div>

    <!-- Review -->
    <div class="tab">
      <div class="row">
        <div class="col-lg-4 col-md-12">
          <div class="product-info">
            <div class="heading-container text-center border-bottom border-dark mb-3">
              <h3 class="color-secondary mb-1">Product Info</h3>
            </div>

            <div class="info-container mb-4">
              <span>Magazine Product:</span>
              <p class="fw-bold review-product-mag mb-0"></p>
            </div>

            <div class="info-container mb-4">
              <span>Format:</span>
              <p class="fw-bold review-format mb-0"></p>
            </div>

            <div class="info-container mb-4">
              <span>Width:</span>
              <p class="fw-bold review-width mb-0">In</p>
            </div>

            <div class="info-container mb-4">
              <span>Height:</span>
              <p class="fw-bold review-height mb-0">In</p>
            </div>

            <div class="info-container mb-4">
              <span>Ad Type:</span>
              <p class="fw-bold review-adType mb-0"></p>
            </div>
          </div>
        </div>
        <div class="col-lg-8 col-md-12">
          <div class="created-sizes-container">
            <div class="heading-container text-center border-bottom border-dark">
              <h3 class="color-secondary mb-1">Applied Standard Size</h3>
            </div>

            <div class="product-table-container mt-3">
              <table class="table product-table">
                <thead>
                  <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Description</th>
                    <th scope="col">No. of Columns</th>
                    <th scope="col">Height</th>
                    <th scope="col">Total Column In.</th>
                    <th scope="col">Status</th>
                  </tr>
                </thead>
                <tbody id="review-standardsize-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="btn-container d-flex justify-content-between mt-5">
        <button class="btn btn-gray step-prev" type="button"><i class="fa fa-solid fa-arrow-left"></i> Previous</button>

        <button id="create-newspaper-btn" data-step="final" class="btn btn-secondary step-next" type="submit">Create Product <i class="fa fa-solid fa-arrow-right"></i></button>
      </div>
    </div>
  </form>
</div>
<script src="{% static 'js/stepform/stepform.js' %}"></script>

<script>
  document.getElementById('create-standardsize-btn').addEventListener('click', function () {
    const payload = {
      description: document.getElementById('size-description').value,
      height: document.getElementById('standardsize-height').value,
      columns: document.getElementById('column-num').value
    };

    fetch('{% url "add_standardsize" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify(payload)
    })
      .then(response => response.json())
      .then(size => {
        // ✅ Add new row to table dynamically
        const table = document.getElementById('sizes-table-body');
        const row = document.createElement('tr');
        row.innerHTML = `
      <td>${size.id}</td>
      <td>${size.description}</td>
      <td>${size.columns}</td>
      <td>${size.height}</td>
      <td>${(size.columns * size.height).toFixed(2)}</td>
      <td>
        ${size.status}
      </td>
    `;
        table.prepend(row); // puts new row at the top

        // ✅ Clear inputs
        document.getElementById('size-description').value = '';
        document.getElementById('standardsize-height').value = '';
        document.getElementById('column-num').value = '';

        // Optional: Update product JSON if needed
        if (typeof updateSelectedSizes === 'function') {
          updateSelectedSizes();
        }
      })
      .catch(err => console.error('Error creating size:', err));
  });
</script>

<script>
  function populateReviewTab() {
    // --- Product Info ---
    const productName = document.getElementById('product-mag').value;
    const height = document.getElementById('height').value;
    const width = document.getElementById('width').value;
    const format = document.getElementById('format').value;
    const adtypeSelect = document.getElementById('ad-type');
    const adtype = adtypeSelect.options[adtypeSelect.selectedIndex].text;

    document.querySelector('.review-product-mag').textContent = productName;
    document.querySelector('.review-height').textContent = height;
    document.querySelector('.review-width').textContent = width;
    document.querySelector('.review-format').textContent = format;
    document.querySelector('.review-adType').textContent = adtype;

    // --- Selected Sizes ---
    const reviewTableBody = document.getElementById('review-standardsize-table-body');
    reviewTableBody.innerHTML = '';

    document.querySelectorAll('#sizes-table-body input[type="checkbox"]:checked').forEach(cb => {
      const row = cb.closest('tr');

      const newRow = document.createElement('tr');
      newRow.innerHTML = `
            <td>${cb.value}</td>
            <td>${row.cells[1].textContent}</td>
            <td>${row.cells[2].textContent}</td>
            <td>${row.cells[3].textContent}</td>
            <td>${parseFloat(row.cells[3].textContent) * parseInt(row.cells[2].textContent)}</td>
            <td>${status.charAt(0).toUpperCase() + status.slice(1)}</td>
        `;
      reviewTableBody.appendChild(newRow);
    });
  }

  // Call this function whenever you go to the review tab
  document.querySelectorAll('.step-next').forEach(button => {
    button.addEventListener('click', function () {
      const currentStep = this.closest('.tab');
      const nextStep = currentStep.nextElementSibling;
      if (nextStep && nextStep.querySelector('#review-standardsize-table-body')) {
        populateReviewTab();
      }
    });
  });
</script>

{% endblock %}
