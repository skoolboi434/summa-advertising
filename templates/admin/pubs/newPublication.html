{% extends 'base.html' %} {% block content %}

<div class="heading-container text-center my-5">
  <h3 class="heading mb-3">New Publication Setup</h3>
</div>

<div class="stepform">
  <div class="steps-container d-none d-md-flex justify-content-md-center mb-5">
    <div class="step active">
      <div class="text">
        <span class="number">1</span>
        <span class="title">General Info</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">2</span>
        <span class="title">Scheduling</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">3</span>
        <span class="title">Rate Groups</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">4</span>
        <span class="title">Ad Criteria</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">5</span>
        <span class="title">Ad Types</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">6</span>
        <span class="title">Adjustments</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">7</span>
        <span class="title">Sections</span>
      </div>
      <div class="arrow">
        <i class="fa fa-solid fa-arrow-right"></i>
      </div>
    </div>
    <div class="step">
      <div class="text">
        <span class="number">8</span>
        <span class="title">Deadlines</span>
      </div>
    </div>
  </div>

  <!-- End Steps -->

  <div class="tab">
    <div class="tab-description text-center mb-5">
      <p>Fill out the information below to begin!</p>
    </div>

    <div class="row">
      <div class="col-md-12 col-lg-6">
        <form method="post" id="add-publication-info-form">
          <div class="form-group mgb-3 center-block text-left">
            <label for=""><span class="asterisk">*</span> Publication Name:</label>
            <input type="text" name="name" id="name" class="form-control" />
          </div>

          <div class="form-group mgb-3 center-block text-left">
            <label for="">Address Line 1:</label>
            <input type="text" name="address" id="" class="form-control" />
            <a href="#">Add another address line</a>
          </div>

          <div class="row mgb-3 center-block">
            <div class="col-md-12 col-lg-6 pl-0">
              <div class="form-group text-left">
                <label for="city">City:</label>
                <input type="text" name="city" id="city" class="form-control" />
              </div>
            </div>
            <div class="col-md-12 col-lg-6 pr-0">
              <div class="form-group text-left">
                <label for="state">State:</label>
                <select name="state" id="state" class="form-control">
                  {% for state in all_states %}
                  <option value="{{state.id}}">{{state.name}} - {{state.abbreviation}}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="row mgb-3 center-block">
            <div class="col-md-12 col-lg-6 pl-0">
              <div class="form-group mgb-3 text-left">
                <label for="city">Zip Code:</label>
                <input type="text" name="zip_code" id="zip-code" class="form-control" />
              </div>
            </div>
            <div class="col-md-12 col-lg-6 ml-4">
              <div class="form-group text-left">
                <label for="country">Country:</label>
                <select name="country" id="country" class="form-control">
                  <option value="">Select Country</option>
                  <script>
                    countries.forEach(country => {
                      document.write(`<option value="${country.name}">${country.name}</option>`);
                    });
                  </script>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group text-left">
            <label for="parent_id">Parent Publication (optional):</label>
            <select name="parent_id" id="parent_id" class="form-control">
              {% for publication in publications %}
              <option value="{{publication.id}}">{{publication.name}}</option>
              {% endfor %}
            </select>
          </div>

          <!-- <div class="btn-container content-even">
        <button class="btn btn-secondary">Save Changes</button>
      </div> -->
        </form>
      </div>
      <div class="col-md-12 col-lg-6">
        <div class="gl-code-builder">
          <span class="d-block">Available Codes:</span>
          <div id="div1" class="available-codes mb-5" ondrop="dropCode(event)" ondragover="allowDrop(event)">
            <button class="btn-custom btn-secondary-light mgb-1" draggable="true" ondragstart="drag(event)" id="location">Location</button>

            <button class="btn-custom btn-secondary-light mgb-1" draggable="true" ondragstart="drag(event)" id="departments">Departments</button>

            <button class="btn-custom btn-secondary-light mgb-1" draggable="true" ondragstart="drag(event)" id="profit">Profit</button>

            <button class="btn-custom btn-secondary-light" draggable="true" ondragstart="drag(event)" id="company">Company</button>
          </div>

          <span class="d-block mb-2">Selected Codes:</span>
          <div id="div2" class="selected-codes mb-5" ondrop="dropCode(event)" ondragover="allowDrop(event)">
            <button class="btn-custom btn-secondary-light" ondragstart="drag(event)" draggable="true" id="GL">GL</button>
          </div>

          <div class="selected-fields-container">
            <div class="text-container text-center mb-5">
              <p>
                Select how many characters you want for each<br />
                selected code!
              </p>
            </div>

            <div class="active-fields">
              <div class="form-group">
                <div id="inputContainer" class="row d-flex justify-content-even">
                  <div class="mb-3">
                    <label for="GL">GL</label>

                    <input type="text" name="GL-text" id="GL-text" class="form-control" />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="btn-container d-flex justify-content-end">
      <button class="btn btn-secondary" type="button" id="nextBtn" onclick="nextPrev(1)">Next <i class="fa fa-solid fa-arrow-right"></i></button>
    </div>
  </div>
</div>

<script>
  let formCount = 1; // To keep track of how many forms are added
  const dateButtonsContainer = document.querySelector('.progress-buttons'); // Assuming this is the container for your date buttons
  const publishDates = [];
  const scheduleForm = [];
  const selectedProducts = [];

  function savePublication(index, id, active, status) {
    let form = $('#add-publication-info-form');

    var formData = new FormData(form[0]);
    let data = {};
    for (const [key, value] of formData) {
      data[key] = value;
    }

    form = $('#new-publication-scheduling-form');

    formData = new FormData(form[0]);
    for (const [key, value] of formData) {
      data[key] = value;
    }
    if (active == 'False') data['active'] = false;
    else data['active'] = true;
    data['status'] = status;
    if (index == 1) {
      data['active'] = !data['active'];
    } else if (index == 2) {
      data['status'] = 2;
    }
    // Check calendar type
    const repeatRadio = document.getElementById('calendar-radio-one');
    if (repeatRadio.checked) {
      var selectElement = document.getElementById('product_type');
      data['product_type'] = selectElement?.value;

      var values = [];
      var selectElement = document.getElementById('edit-pub-rategroup-lstBox2');
      var values = [];

      for (var i = 0; i < selectElement.options.length; i++) {
        values.push(selectElement.options[i].value);
      }
      data['rategroup_id'] = values;

      var selectElement = document.getElementById('edit-pub-criteria-lstBox2');
      var values = [];

      for (var i = 0; i < selectElement.options.length; i++) {
        values.push(selectElement.options[i].value);
      }
      data['adcriteria_id'] = values;

      var selectElement = document.getElementById('edit-pub-adtype-lstBox2');
      var values = [];

      for (var i = 0; i < selectElement.options.length; i++) {
        values.push(selectElement.options[i].value);
      }
      data['adtype_id'] = values;

      var selectElement = document.getElementById('edit-pub-adjustment-lstBox2');
      var values = [];

      for (var i = 0; i < selectElement.options.length; i++) {
        values.push(selectElement.options[i].value);
      }
      data['adjustment_id'] = values;

      var selectElement = document.getElementById('edit-pub-section-lstBox2');
      var values = [];

      for (var i = 0; i < selectElement.options.length; i++) {
        values.push(selectElement.options[i].value);
      }
      data['section_id'] = values;

      console.log(data);
      // Handle text inputs (GL, location, profit, company, departments)
      const inputIDs = ['GL-text', 'location-text', 'profit-text', 'company-text', 'departments-text'];
      inputIDs.forEach(inputID => {
        var selectElement = document.getElementById(inputID);
        var selectedValue = selectElement?.value; // Get the value of the input field
        if (selectedValue) {
          data[inputID] = selectedValue;
        }
      });

      // Handle the selected days (run_days)

      var runDaysInput = document.getElementById('run_days');
      data['run_days'] = runDaysInput?.value;

      const days = runDaysInput?.value;
      const selectedDayss = JSON.parse(days);

      data['deadline'] = [];
      selectedDayss.forEach(day => {
        // Get the press on/off status
        const pressActive = document.querySelector(`input[name="${day}_press_onoff"]:checked`)?.value;
        const paginationActive = document.querySelector(`input[name="${day}_pagination_onoff"]:checked`)?.value;

        // Collect Press data if "On"
        if (pressActive === 'on') {
          const pressDay = document.querySelector(`select[name="${day}_press_day"]`)?.value;
          const pressHour = document.querySelector(`select[name="${day}_press_hour"]`)?.value;
          const pressMinute = document.querySelector(`select[name="${day}_press_minute"]`)?.value;
          const pressPeriod = document.querySelector(`select[name="${day}_press_period"]`)?.value;

          // Add Press data to the deadline array
          data['deadline'].push({
            [`${day}-press`]: {
              weekofday: pressDay,
              hour: pressHour,
              minute: pressMinute,
              period: pressPeriod
            }
          });
        }

        // Collect Pagination data if "On"
        if (paginationActive === 'on') {
          const paginationDay = document.querySelector(`select[name="${day}_pagination_day"]`)?.value;
          const paginationHour = document.querySelector(`select[name="${day}_pagination_hour"]`)?.value;
          const paginationMinute = document.querySelector(`select[name="${day}_pagination_minute"]`)?.value;
          const paginationPeriod = document.querySelector(`select[name="${day}_pagination_period"]`)?.value;

          // Add Pagination data to the deadline array
          data['deadline'].push({
            [`${day}-pagination`]: {
              weekofday: paginationDay,
              hour: paginationHour,
              minute: paginationMinute,
              period: paginationPeriod
            }
          });
        }
      });
    }

    data['non_repeating'] = [];

    publishDates?.forEach(product => {
      // Get the press on/off status
      const pressDate = document.querySelector(`input[name="${product.date}_press_date"]`);
      const pressHour = document.querySelector(`select[name="${product.date}_press_hour"]`);
      const pressMinute = document.querySelector(`select[name="${product.date}_press_minute"]`);
      const pressPeriod = document.querySelector(`select[name="${product.date}_press_period"]`);

      // Add Press data to the deadline array
      data['non_repeating'].push({
        [`${product.date}-press`]: {
          nonRepeatDate: pressDate?.value,
          hour: pressHour?.value,
          minute: pressMinute?.value,
          period: pressPeriod?.value
        }
      });

      const paginationDate = document.querySelector(`input[name="${product.date}_pagination_date"]`);
      const paginationHour = document.querySelector(`select[name="${product.date}_pagination_hour"]`);
      const paginationMinute = document.querySelector(`select[name="${product.date}_pagination_minute"]`);
      const paginationPeriod = document.querySelector(`select[name="${product.date}_pagination_period"]`);

      // Add Pagination data to the deadline array
      data['non_repeating'].push({
        [`${product.date}-pagination`]: {
          nonRepeatDate: paginationDate?.value,
          hour: paginationHour?.value,
          minute: paginationMinute?.value,
          period: paginationPeriod?.value
        }
      });
    });

    data['non_repeating_deadline'] = data['non_repeating_deadline'] || []; // Initialize only if not already initialized
    const nonRepeatRadio = document.getElementById('calendar-radio-two');
    for (let i = 1; i <= formCount; i++) {
      if (nonRepeatRadio.checked) {
        const name = document.getElementById(`name_${i}`).value;
        const product_type = document.getElementById(`product_type_${i}`).value || '';
        const gl_code = document.getElementById(`gl_code_${i}`).value;

        //Rate Groups
        var selectElement = document.getElementById(`edit-pub-rategroup-${i}-lstBox2`);
        var values = [];

        for (var e = 0; e < selectElement.options.length; e++) {
          values.push(selectElement.options[e].value);
        }
        const rategroups = values;

        //Adtypes Groups
        var selectElement = document.getElementById(`edit-pub-adtype-${i}-lstBox2`);
        var values = [];

        for (var e = 0; e < selectElement.options.length; e++) {
          values.push(selectElement.options[e].value);
        }
        const adtypes = values;

        //Adjustments
        var selectElement = document.getElementById(`edit-pub-adjustment-${i}-lstBox2`);
        var values = [];

        for (var e = 0; e < selectElement.options.length; e++) {
          values.push(selectElement.options[e].value);
        }
        var adjustments = values;

        //Sections
        var selectElement = document.getElementById(`edit-pub-sections-${i}-lstBox2`);
        var values = [];

        for (var e = 0; e < selectElement.options.length; e++) {
          values.push(selectElement.options[e].value);
        }
        var sections = values;

        //Ad Criteria
        var selectElement = document.getElementById(`edit-pub-criteria-${i}-lstBox2`);
        var values = [];

        for (var e = 0; e < selectElement.options.length; e++) {
          values.push(selectElement.options[e].value);
        }
        var adCriterias = values;

        // Ensure scheduleform is available and accessible

        // Find the corresponding form based on formid
        console.log(scheduleForm);

        const filterform = scheduleForm.find(form => form.formid == i); // Use .find() for the first match
        const dates = filterform && filterform.dates; // Default to empty array if not found

        // Debug: Check what dates are found

        // Push the form data including the dates into the non_repeating_deadline array
        data['non_repeating_deadline'].push({
          [`form-${i}`]: {
            name: name,
            product_type: product_type,
            gl_code: gl_code,
            rategroups: rategroups,
            adtypes: adtypes,
            adCriterias: adCriterias,
            adjustments: adjustments,
            sections: sections,
            dates: dates // Add the dates array to the form data
          }
        });
      }
    }

    var hrefUrl = `{% url 'adminGeneral' %}`;
    fetch(`create-publication`, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        Accept: 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(response => response.json())
      .then(res => {
        $.toastr.success('Publication saved successfully!');
        window.location.href = hrefUrl;
      })
      .catch(error => {
        $.toastr.error('Saving Publication Failed');
      });
  }

  function initializeCalendar() {
    const year = 2024; // Set the initial year
    const month = 9; // October (0-based index)

    const rundaysString = document.getElementById('run_days').value; // Get the string from input

    // Convert the day names in rundaysArray to their corresponding numeric values
    const rundays = rundaysString;

    // Call the function to generate the calendar
    generateCalendar(year, month, rundays);
  }

  // Call the initialize function when the page loads
  window.onload = initializeCalendar;

  // For Repeating Publications
  function generateTabsAndFields(selectedDays) {
    const dayTabs = document.getElementById('dayTabs');
    const tabContent = document.getElementById('tabContent');

    // Clear any previous content
    dayTabs.innerHTML = '';
    tabContent.innerHTML = '';

    selectedDays.forEach((day, index) => {
      // Create tab for each day
      const tab = document.createElement('button');
      tab.textContent = day;
      tab.classList.add('tab');
      tab.style.margin = '10px';
      tab.style.background = index === 0 ? 'lightblue' : 'white';
      tab.style.border = '1px solid lightgray';
      tab.style.borderRadius = '5px';
      tab.style.padding = '5px 15px';

      if (index === 0) {
        tab.classList.add('active'); // Add active class to the first tab
      }

      tab.onclick = function () {
        // Reset previous active tab color
        const activeTab = dayTabs.querySelector('.active');
        if (activeTab) {
          activeTab.classList.remove('active');
          activeTab.style.background = 'white'; // Reset to original color
        }

        // Set the clicked tab as active
        tab.classList.add('active');
        tab.style.background = 'lightblue'; // Change color to indicate active state

        showTabContent(day);
      };
      dayTabs.appendChild(tab);

      // Create content for each tab (form fields for Press and Pagination)
      const content = document.createElement('div');
      content.classList.add('tab-pane');
      content.id = `tab-${day}`;

      content.style.display = index === 0 ? 'block' : 'none'; // Show first tab by default

      content.innerHTML += ` 
            <div style="display:flex; justify-content: space-between; align-items:center; background:white; padding:15px; border:1px solid lightgray">
                <h6><b>${day} - Press</b></h6>
                <div>
                    <input type="radio" name="${day}_press_onoff" value="on" checked> On
                    <input type="radio" name="${day}_press_onoff" value="off"> Off
                </div>
                <div style="display:flex; alignitem:center; gap:5px">
                    <label style="margin-top:10px"><b>Due By:</b></label>
                    
                    <input type="date" name="${day}_press_date" class="form-control" style="width:150px; background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;"/>
                    <select name="${day}_press_hour" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateHourOptions()}</select>
                    <select name="${day}_press_minute" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateMinuteOptions()}</select>
                    <select name="${day}_press_period" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </div>
            </div>
        `;

      content.innerHTML += ` 
            <div style="display:flex; justify-content: space-between; align-items:center; background:white; padding:15px; border:1px solid lightgray">
                <h6><b>${day} - Pagination</b></h6>
                <div>
                    <input type="radio" name="${day}_pagination_onoff" value="on" checked> On
                    <input type="radio" name="${day}_pagination_onoff" value="off"> Off
                </div>
                <div style="display:flex; alignitem:center; gap:5px">
                    <label style="margin-top:10px"><b>Due By:</b></label>
                    
                    <input type="date" name="${day}_pagination_date" class="form-control" style="width:150px; background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;"/>
                    <select name="${day}_pagination_hour" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateHourOptions()}</select>
                    <select name="${day}_pagination_minute" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateMinuteOptions()}</select>
                    <select name="${day}_pagination_period" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </div>
            </div>
        `;

      tabContent.appendChild(content);
    });
  }

  function showTabContent(day) {
    const allTabs = document.querySelectorAll('.tab-pane');
    allTabs.forEach(tab => (tab.style.display = 'none')); // Hide all tabs
    document.getElementById(`tab-${day}`).style.display = 'block'; // Show selected tab
  }

  // Helper functions to generate options
  function generateDayOptions() {
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return days.map(day => `<option value="${day}">${day}</option>`).join('');
  }

  function generateHourOptions() {
    let options = '';
    for (let i = 0; i < 24; i++) {
      options += `<option value="${i}">${i}</option>`;
    }
    return options;
  }

  function generateMinuteOptions() {
    let options = '';
    for (let i = 0; i < 60; i++) {
      options += `<option value="${i}">${i}</option>`;
    }
    return options;
  }

  // Function to allow dropping of elements
  function allowDrop(event) {
    event.preventDefault(); // Necessary to allow drop events
  }

  // Function to handle dragging
  function drag(event) {
    event.dataTransfer.setData('text', event.target.id); // Get the id of the dragged element
  }

  // Function to handle dropping the element and manage input fields visibility
  function dropCode(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData('text');
    var draggedElement = document.getElementById(data);
    var dropZone = ev.target.closest('#div1, #div2') || ev.target;

    if (dropZone.id === 'div2') {
      dropZone.appendChild(draggedElement);
      const inputId = `${draggedElement.id}-text`;
      const existingInput = document.getElementById(inputId);
      if (!existingInput) {
        const div = document.createElement('div');
        div.className = 'mb-3';

        const label = document.createElement('label');
        label.htmlFor = draggedElement.id;
        label.textContent = draggedElement.id;

        const input = document.createElement('input');
        input.type = 'text';
        input.name = inputId;
        input.id = inputId;
        input.className = 'form-control';

        div.appendChild(label);
        div.appendChild(input);
        document.getElementById('inputContainer').appendChild(div);
      }
    } else if (dropZone.id === 'div1') {
      dropZone.appendChild(draggedElement);
      const inputId = `${draggedElement.id}-text`;
      const inputField = document.getElementById(inputId);
      if (inputField && inputField.parentElement) {
        inputField.parentElement.remove();
      }
    }
  }

  // Function to toggle input field visibility for selected/deselected codes
  function toggleInputField(codeId, show) {
    const inputField = document.getElementById(`${codeId}-text`);
    const labelField = document.querySelector(`label[for="${codeId}-text"]`);

    if (show) {
      if (inputField) inputField.style.display = 'block';
      if (labelField) labelField.style.display = 'block';
    } else {
      if (inputField) inputField.style.display = 'none';
      if (labelField) labelField.style.display = 'none';
    }
  }

  // Function to clear the text box when moved to Selected Codes
  function clearTextBox(codeId) {
    const inputField = document.getElementById(`${codeId}-text`);
    if (inputField) {
      inputField.value = ''; // Clear the text box value
    }
  }

  // New function to check if any input fields have "Enter Code!" and move them back to Available Codes
  function checkAndMoveInvalidCodes() {
    const selectedCodesContainer = document.getElementById('div2');
    const availableCodesContainer = document.getElementById('div1');

    // Get all selected buttons in the selected codes container
    const selectedButtons = selectedCodesContainer.querySelectorAll('button');

    selectedButtons.forEach(button => {
      const codeId = button.id;
      const inputField = document.getElementById(`${codeId}-text`);

      // If the input field has "Enter Code!" move the button back to available codes
      if (inputField && inputField.value === 'Enter Code!') {
        availableCodesContainer.appendChild(button); // Move button back to available codes
        toggleInputField(codeId, false); // Hide the corresponding input field
      }
    });
  }

  // Attach drag event listeners to all draggable buttons
  document.querySelectorAll('.available-codes button, .selected-codes button').forEach(button => {
    button.addEventListener('dragstart', drag);
  });

  // Call checkAndMoveInvalidCodes after form submission or on form load
  document.addEventListener('DOMContentLoaded', function () {
    restoreCodeState();
    checkAndMoveInvalidCodes();
    // Ensure drag-and-drop works by re-attaching drag events
    document.querySelectorAll('.available-codes button, .selected-codes button').forEach(button => {
      button.addEventListener('dragstart', drag);
    });
  });

  function restoreCodeState() {
    const availableCodesElement = document.getElementById('available_codes_state');
    const availableCodes = availableCodesElement ? JSON.parse(availableCodesElement?.value) : [];

    const selectedCodesElement = document.getElementById('selected_codes_state');
    const selectedCodes = selectedCodesElement ? JSON.parse(selectedCodesElement?.value) : [];

    const availableCodesContainer = document.getElementById('div1');
    const selectedCodesContainer = document.getElementById('div2');

    // Move boxes to their respective sections
    availableCodes.forEach(codeId => {
      const element = document.getElementById(codeId);
      if (element) {
        availableCodesContainer.appendChild(element);
        toggleInputField(codeId, false); // Hide the corresponding input field
      }
    });

    selectedCodes.forEach(codeId => {
      const element = document.getElementById(codeId);
      if (element) {
        selectedCodesContainer.appendChild(element);
        toggleInputField(codeId, true); // Show the corresponding input field
      }
    });
  }

  function initializeScheduleButtons() {
    const buttons = document.querySelectorAll('.schedule-select-btn');
    const initialScheduleType = '2'; // Set default value to "2" for Weekly

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class and reset styles for all buttons
        buttons.forEach(btn => {
          btn.style.backgroundColor = '';
          btn.style.color = '';
        });

        // Add active style to the clicked button
        button.style.backgroundColor = '#f26722';
        button.style.color = 'white';
      });
    });

    // Set the default "Weekly" button as active based on the initial value
    const initialButton = Array.from(buttons).find(button => button.getAttribute('data-value') === initialScheduleType);
    if (initialButton) {
      initialButton.style.backgroundColor = '#f26722';
      initialButton.style.color = 'white';
    }
  }

  // Initialize buttons on page load
  initializeScheduleButtons();

  function getDayName(dayValue) {
    switch (dayValue) {
      case '1':
        return 'Sun';
      case '2':
        return 'Mon';
      case '3':
        return 'Tue';
      case '4':
        return 'Wed';
      case '5':
        return 'Thur';
      case '6':
        return 'Fri';
      case '7':
        return 'Sat';
      default:
        return '';
    }
  }

  function initializeDayOfWeekPicker() {
    const checkboxes = document.querySelectorAll('.dow-pickerr-option input[type="checkbox"]');
    const runDaysInput = document.getElementById('run_days');
    let runDays = runDaysInput ? runDaysInput.value : ''; // Ensure the value is safely retrieved

    // Convert string "['Mon', 'Tue']" to an array ['Mon', 'Tue']
    if (runDays) {
      // Remove square brackets and single quotes, then split by commas
      runDays = runDays
        .replace(/[\[\]']/g, '')
        .split(',')
        .map(day => day.trim());

      // Loop through the array and check the corresponding checkboxes
      runDays?.forEach(function (day) {
        const checkbox = document.querySelector(`input[value="${day}"]`);
        if (checkbox) {
          checkbox.checked = true;
        }
      });
    }

    function updateRunDaysInput() {
      const selectedDays = Array.from(checkboxes)
        .filter(checkbox => checkbox.checked)
        .map(checkbox => checkbox.value); // Just use value, no need for getDayName

      // Update the hidden input with the selected days
      runDaysInput.value = JSON.stringify(selectedDays);

      // Call the function to update the display of selected days
      generateTabsAndFields(selectedDays);

      initializeCalendar();
    }

    // Attach change event listener to checkboxes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateRunDaysInput);
    });

    // Call the function to update the display on page load
    updateRunDaysInput();
  }

  // Initialize the day-of-week picker
  initializeDayOfWeekPicker();

  document.getElementById('add-schedule-button').addEventListener('click', function () {
    // Only call the function if there are already dates in publishDates
    addScheduleForm();
  });

  function addScheduleForm() {
    formCount++; // Increment the form count with each new form

    // Find the form container
    const formContainer = document.getElementById('form-container');

    // Clone the first form section
    const newForm = formContainer.querySelector('.form-section').cloneNode(true);

    // Clear the values of the input fields in the cloned form
    const inputs = newForm.querySelectorAll('input, select');
    inputs.forEach(input => {
      if (input.type === 'radio') {
        input.checked = false; // Uncheck all radio buttons
      } else {
        input.value = ''; // Clear other input fields
      }
    });

    // Update the radio button IDs and name attributes with a numerical prefix
    const radioButtons = newForm.querySelectorAll('input[type="radio"]');
    radioButtons.forEach((radio, index) => {
      radio.id = `${formCount}-non-repeat-gl-override-radio-${index}`;
      radio.name = `gl_override_${formCount}`;

      if (radio.value === 'Yes') {
        radio.checked = true; // Check the "yes" button by default
      }
    });

    // Update the corresponding labels' `for` attributes to match the new radio button IDs
    const labels = newForm.querySelectorAll('label[for^="non-repeat-gl-override-radio"]');
    labels.forEach((label, index) => {
      label.setAttribute('for', `${formCount}-non-repeat-gl-override-radio-${index}`);
    });

    // Assign unique IDs to date-related input fields
    const nameInput = newForm.querySelector('input[type="text"][name="name"]');
    nameInput.classList.add(`name_${formCount}`);
    nameInput.id = `name_${formCount}`;

    const productTypeSelect = newForm.querySelector('[name="product_type"]');
    productTypeSelect.classList.add(`product_type_${formCount}`);
    productTypeSelect.id = `product_type_${formCount}`;

    const glCodeSelect = newForm.querySelector('[name="gl_code"]');
    glCodeSelect.classList.add(`gl_code_${formCount}`);
    glCodeSelect.id = `gl_code_${formCount}`;

    const publishDateInput = newForm.querySelector('input[type="date"][name="start_date"]');
    publishDateInput.classList.add('publish-date');
    publishDateInput.id = `publish-date-${formCount}`;

    const deadlineHourInput = newForm.querySelector('[name="deadline-hour"]');
    deadlineHourInput.classList.add('deadline-hour');
    deadlineHourInput.id = `deadline-hour-${formCount}`;

    const timePeriodInput = newForm.querySelector('[name="time_period"]');
    timePeriodInput.classList.add('time-period');
    timePeriodInput.id = `time-period-${formCount}`;

    // Clear table contents in the new form
    const table = newForm.querySelector('.table-1'); // Assuming the table has a class of 'table-1'
    table.classList.remove('table-1'); // Remove the old class
    table.classList.add(`table-${formCount}`); // Add unique class based on form count
    const tableBody = table.querySelector('tbody'); // Find the table body
    if (tableBody) {
      tableBody.innerHTML = ''; // Clear all rows in the table body
    }

    // Set unique button ID and onclick event for adding rows to the table
    const addButton = newForm.querySelector('#add_form_table_1'); // Assuming the button is within the same form section
    addButton.id = `add_form_table_${formCount}`; // Set unique button ID
    addButton.setAttribute('onclick', `addDateDeadlineToTable(${formCount})`); // Update onclick event

    // Append the new form section to the container
    const newFormWrapper = document.createElement('div');
    newFormWrapper.classList.add('col-md-12', 'col-lg-12', 'form-section');
    newFormWrapper.style.marginLeft = '0px'; // Adjust as needed
    newFormWrapper.style.marginTop = '15px'; // Adjust as needed
    newFormWrapper.appendChild(newForm); // Append the cloned form to the wrapper
    formContainer.appendChild(newFormWrapper);
    // Add the new form wrapper to the form container
  }

  function generateCalendar(year, month, rundays) {
    calendar.innerHTML = ''; // Clear previous calendar
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    // Create month navigation
    const monthNavigation = document.createElement('div');
    monthNavigation.classList.add('datepicker-header');
    monthNavigation.style.display = 'flex'; // Use Flexbox
    monthNavigation.style.justifyContent = 'space-between'; // Space between items
    monthNavigation.style.alignItems = 'center'; // Center items vertically

    const prevButton = document.createElement('button');
    prevButton.textContent = '◀';
    prevButton.classList.add('datepicker-month-btn');
    prevButton.onclick = () => changeMonth(year, month - 1, rundays);

    const nextButton = document.createElement('button');
    nextButton.textContent = '▶';
    nextButton.classList.add('datepicker-month-btn');
    nextButton.onclick = () => changeMonth(year, month + 1, rundays);

    const monthLabel = document.createElement('span');
    monthLabel.textContent = `${monthNames[month]} ${year}`; // Fixed template literal syntax
    monthLabel.classList.add('datepicker-month-label');

    monthNavigation.appendChild(prevButton);
    monthNavigation.appendChild(monthLabel);
    monthNavigation.appendChild(nextButton);
    calendar.appendChild(monthNavigation);

    // Create days of the week header
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    const table = document.createElement('table');
    table.style.borderCollapse = 'separate'; // Ensures borders can be set with spacing
    table.style.borderSpacing = '0'; // Sets the gap between cells

    const headerRow = document.createElement('tr');
    headerRow.classList.add('datepicker-days-header');
    headerRow.style.marginBottom = '10px';
    headerRow.style.background = '#dedee7';

    daysOfWeek.forEach(day => {
      const th = document.createElement('th');
      th.style.background = '#dedee7';
      th.textContent = day;
      headerRow.appendChild(th);
    });

    table.appendChild(headerRow);

    // Get first and last day of the month
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    let dateRow = document.createElement('tr');
    let dayCount = 1;

    // Create hidden cells for days before the first day of the month
    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('td');
      emptyCell.style.visibility = 'hidden'; // Hide the empty cells
      dateRow.appendChild(emptyCell);
    }

    // Create calendar cells for each day
    for (let i = firstDay; i < 7; i++) {
      const dayCell = createDayCell(year, month, dayCount, rundays);
      dateRow.appendChild(dayCell);
      dayCount++;
    }
    table.appendChild(dateRow);

    // Continue creating rows until the month is filled
    while (dayCount <= daysInMonth) {
      dateRow = document.createElement('tr');
      for (let i = 0; i < 7 && dayCount <= daysInMonth; i++) {
        const dayCell = createDayCell(year, month, dayCount, rundays);
        dateRow.appendChild(dayCell);
        dayCount++;
      }
      table.appendChild(dateRow);
    }

    calendar.appendChild(table);

    // Apply styles for date cells
    const dayCells = table.querySelectorAll('td');
    dayCells.forEach(cell => {
      cell.style.width = '30px'; // Set a fixed width if needed
      cell.style.height = '30px'; // Set a fixed height if needed
      cell.style.textAlign = 'center'; // Center text
      cell.style.border = '1px solid #ccc'; // Set border for each cell
    });
  }

  // Function to handle month change, adjusting year if necessary
  function changeMonth(year, month, rundays) {
    if (month < 0) {
      month = 11;
      year -= 1;
    } else if (month > 11) {
      month = 0;
      year += 1;
    }
    generateCalendar(year, month, rundays);
  }

  // Create individual day cells
  function createDayCell(year, month, day, rundays) {
    const dayCell = document.createElement('td');
    dayCell.textContent = day;

    // Get the numeric day of the week (0 = Sunday, 1 = Monday, ..., 6 = Saturday)
    const date = new Date(year, month, day);
    const dayOfWeek = date.getDay(); // Gets the day of the week

    // Mapping of day numbers to names
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Get the day name for the current numeric day
    const dayName = dayNames[dayOfWeek];

    // Check if the day name is in the rundays array
    if (!rundays || rundays.length === 0 || rundays.includes(dayName)) {
      dayCell.classList.add('enabled');

      // Check if the day is selected
      if (rundays.includes(dayName)) {
        dayCell.classList.add('selected'); // Highlight selected days
      }

      // Start multi-select with left-click and drag
      dayCell.addEventListener('mousedown', event => {
        if (event.button === 0) {
          // Left-click
          isDragging = true;
          startDate = date; // Updated to create date from day
          toggleDateSelection(startDate); // Select the start date immediately
          dayCell.classList.add('selected');
        }
      });

      dayCell.addEventListener('mouseover', () => {
        if (isDragging) {
          handleDateRangeSelection(startDate, date); // Select range as you drag
        }
      });

      dayCell.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          startDate = null;
        }
      });

      // Prevent text selection while dragging
      dayCell.addEventListener('dragstart', event => event.preventDefault());
    } else {
      // dayCell.classList.add('disabled');
      // dayCell.onclick = () => {
      //     alert(`Day ${day} is not selectable.`);
      // };
    }

    return dayCell;
  }
  // Handle selection of a date range (when dragging)
  function handleDateRangeSelection(start, end) {
    // Ensure start is before end
    if (start > end) {
      [start, end] = [end, start];
    }

    const cells = document.querySelectorAll('td.enabled');
    selectedDates = []; // Clear current selection

    cells.forEach(cell => {
      const cellDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(cell.textContent));

      if (cellDate >= start && cellDate <= end) {
        if (!selectedDates.some(d => d.getTime() === cellDate.getTime())) {
          selectedDates.push(cellDate);
        }
        cell.classList.add('selected'); // Highlight the selected cells
      } else {
        cell.classList.remove('selected'); // Remove highlight from non-selected cells
      }
    });

    // Update the input field with the selected dates
    dateInput.value = selectedDates.map(d => formatDate(d)).join(', ');
  }

  // Toggle the date selection
  function toggleDateSelection(date) {
    const index = selectedDates.findIndex(d => d.getTime() === date.getTime());

    if (index >= 0) {
      selectedDates.splice(index, 1); // Remove if already selected
    } else {
      selectedDates.push(date); // Add to selection
    }

    // Update the input field with the selected dates
    dateInput.value = selectedDates.map(d => formatDate(d)).join(', ');
  }

  // Detect global mouseup to stop dragging outside the calendar
  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  // Your function wrapped in the DOMContentLoaded event

  // Function to delete an entry from the schedule form
  function addDateDeadlineToTable(id) {
    // Get selected publish and deadline dates
    const name = document.getElementById(`name_${id}`).value;
    const productType = document.getElementById(`product_type_${id}`).value;
    const glCode = document.getElementById(`gl_code_${id}`).value;
    const publishDate = document.getElementById(`publish-date-${id}`).value;
    const deadlineHour = document.getElementById(`deadline-hour-${id}`).value;
    const timePeriod = document.getElementById(`time-period-${id}`).value;

    // Concatenate hour and period for deadline display
    const formattedDeadline = `${deadlineHour}:00 ${timePeriod}`;

    // Select the table body where rows will be added
    const tableBody = document.querySelector(`.table-${id} tbody`);

    // Log whether the table body was found
    if (!tableBody) {
      return; // Early exit if the table body is not found
    }

    // Check if publish date and deadline date are not empty
    if (publishDate) {
      // Create the object for the date entry
      const newDateEntry = {
        publishDate: publishDate,
        deadlineHour: deadlineHour,
        timePeriod: timePeriod
      };

      // Find the form entry with the matching formid in the scheduleForm array

      let formEntry = scheduleForm.find(form => form.formid == id); // Match form by formid

      if (formEntry) {
        // If the form exists, update its name, productType, and glCode if necessary
        formEntry.name = name;
        formEntry.product_type = productType;
        formEntry.gl_code = glCode;

        // Check if the publish date already exists in the form's dates array
        const existingEntry = formEntry.dates.find(entry => entry.publishDate === publishDate);
        if (existingEntry) {
          alert('This publish date already exists in this form.');
          return; // Exit if the publish date already exists
        }

        publishDates?.push({ date: publishDate, name: name });
        console.log('publishDates', publishDates);

        // Add the new date entry to the form's dates array
        formEntry.dates.push(newDateEntry);

        // Create a new table row with publish date and formatted deadline
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
                <td style="text-align: start;">${publishDate}</td>
                <td style="text-align: start;">${formattedDeadline}</td>
                <td>
                    <span class="pe-5" style="cursor: pointer;" onclick="deleteEntry(this, ${id})">
                        <i class="fa fa-solid fa-trash"></i>
                    </span>
                </td>
            `;

        // Append the new row to the table body
        tableBody.appendChild(newRow);
      } else {
        // If the form does not exist in scheduleForm, create a new one
        formEntry = {
          formid: id,
          name: name,
          product_type: productType,
          gl_code: glCode,
          dates: [newDateEntry] // Initialize with the new date entry
        };
        scheduleForm.push(formEntry);
        publishDates?.push({ date: publishDate, name: name });

        // Create a new table row with publish date and formatted deadline
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
                <td style="text-align: start;">${publishDate}</td>
                <td style="text-align: start;">${formattedDeadline}</td>
                <td>
                    <span class="pe-5" style="cursor: pointer;" onclick="deleteEntry(this, ${id})">
                        <i class="fa fa-solid fa-trash"></i>
                    </span>
                </td>
            `;

        // Append the new row to the table body
        tableBody.appendChild(newRow);
      }

      // Optional: Update tabs or other UI elements related to the form
      createProductTabs();
      updateDateTabs(name);
      populateRateGroupContent(id);
      populateAdtypeContent(id);
      populateAdCriteriaContent(id);
      populateAdjustmentsContent(id);
      populateSectionsContent(id);
      switchTab(1);
    } else {
      alert('Please select both publish and deadline dates.');
    }
  }

  // Function to delete an entry from the schedule form
  function deleteEntry(spanElement, formId) {
    const row = spanElement.closest('tr');
    row.remove(); // Remove the row from the table

    // Get the publish date from the row
    const publishDate = row.cells[0].textContent;

    // Find the form entry with the given formId
    const formEntry = scheduleForm.find(form => form.formid === formId);

    if (formEntry) {
      // Find the index of the date entry to remove
      const dateIndex = formEntry.dates.findIndex(entry => entry.publishDate === publishDate);

      if (dateIndex !== -1) {
        // Remove the date entry from the dates array
        formEntry.dates.splice(dateIndex, 1);
      }
    }
  }

  function createProductTabs() {
    // Select all products list containers and product headings
    const productsListContainers = document.querySelectorAll('.products-list');
    const productHeadings = document.querySelectorAll('.product_heading');
    const datetabs = document.getElementById('date-tabs');

    datetabs.style.display = 'none'; // Hide date tabs initially

    const nameFields = document.querySelectorAll('.form-section input[name="name"]');

    // Loop over each products list container
    productsListContainers.forEach((productsListContainer, containerIndex) => {
      productsListContainer.innerHTML = ''; // Clear any existing product tabs for each container

      nameFields.forEach((nameField, index) => {
        const productName = nameField.value;

        // Check if productName is not null, undefined, or an empty string
        if (productName) {
          const tab = document.createElement('div');
          tab.classList.add('product-tab');
          tab.textContent = productName;
          tab.style.margin = '10px';
          tab.style.background = index === 0 ? 'lightblue' : 'white';
          tab.style.border = '1px solid lightgray';
          tab.style.borderRadius = '5px';
          tab.style.padding = '5px 15px';

          // Add click event for each product tab
          tab.addEventListener('click', () => {
            // Reset all tabs in this specific products list container
            productsListContainer.querySelectorAll('.product-tab').forEach(t => {
              t.classList.remove('active');
              t.style.background = 'white';
            });
            switchTab(index + 1);

            tab.classList.add('active');
            tab.style.background = 'lightblue';

            // Update the corresponding product heading
            productHeadings[containerIndex].textContent = productName;

            updateDateTabs(productName); // Pass the product name to update dates
          });

          productsListContainer.appendChild(tab);

          // If this is the first tab, set it as active and update date tabs immediately
          if (index === 0) {
            tab.classList.add('active');
            updateDateTabs(productName);
            // Display dates for the first product by default
            productHeadings[containerIndex].textContent = productName; // Set heading to first product
          }
        }
      });
    });
  }

  function updateDateTabs(selectedProductName) {
    const datetabs = document.getElementById('date-tabs');
    datetabs.innerHTML = ''; // Clear existing date tabs

    // Set display to flex and add gap
    datetabs.style.display = 'flex';
    datetabs.style.gap = '10px'; // Adjust the gap size as needed

    // Filter dates based on the selected product name in scheduleForm
    const relevantDates = scheduleForm.filter(item => item.name === selectedProductName);

    // Check if relevant dates exist for the selected product
    if (relevantDates.length > 0) {
      relevantDates.forEach((dateInfo, index) => {
        // Loop through the dates for this product
        dateInfo.dates.forEach((dateData, dateIndex) => {
          const dateTab = document.createElement('div');
          dateTab.classList.add('date-tab');
          const formattedDate = `${dateData.publishDate}`; // Display the date and time period
          dateTab.textContent = formattedDate;
          dateTab.style.margin = '0'; // Remove margin for inline alignment
          dateTab.style.padding = '5px 10px';
          dateTab.style.background = 'white'; // Default background for inactive tabs
          dateTab.style.border = '1px solid lightgray';
          dateTab.style.borderRadius = '5px';
          dateTab.style.cursor = 'pointer'; // Change cursor to pointer for better UX

          // Add click event listener to each date tab
          dateTab.addEventListener('click', () => {
            // Reset background colors of all tabs
            document.querySelectorAll('.date-tab').forEach(t => {
              t.classList.remove('active');
              t.style.background = 'white'; // Reset background color for inactive tabs
            });

            // Set active tab background color
            dateTab.classList.add('active');
            dateTab.style.background = 'lightblue'; // Change active tab background color
            generateFieldsForSelectedDate(dateData.publishDate); // Show fields for the selected date
          });

          datetabs.appendChild(dateTab);

          // If this is the first date tab, set it as active by default and show its fields
          if (index == 0 && dateIndex == 0) {
            dateTab.classList.add('active');
            dateTab.style.background = 'lightblue'; // Set active tab background color
            generateFieldsForSelectedDate(dateData.publishDate); // Show fields for the first date by default
          }
        });
      });

      // Show date tabs if relevant dates exist
      datetabs.style.display = 'flex';
    } else {
      // Hide the date tabs if no relevant dates exist for the selected product
      datetabs.style.display = 'none';
    }
  }

  // Generate press and pagination fields for the selected date
  function generateFieldsForSelectedDate(date) {
    const tabContent = document.getElementById('date-tabs-content');

    // Hide all existing tab contents except for the selected date
    const existingTabs = tabContent.getElementsByClassName('tab-pane');
    for (let i = 0; i < existingTabs.length; i++) {
      if (existingTabs[i].id == `tab-${date}`) {
        existingTabs[i].style.display = 'block'; // Show the selected date's content
      } else {
        existingTabs[i].style.display = 'none'; // Hide the other contents
      }
    }

    // Check if the content for the selected date already exists

    let content = document.getElementById(`tab-${date}`);
    if (!content) {
      // Create new content if it doesn't exist
      content = document.createElement('div');
      content.classList.add('tab-pane');
      content.id = `tab-${date}`;
      content.style.display = 'block'; // Show the new content

      content.innerHTML += ` 
            <div style="display:flex; justify-content: space-between; align-items:center; background:white; padding:15px; border:1px solid lightgray">
                <h6><b>${date} - Press</b></h6>
                <div>
                    <input type="radio" name="${date}_press_onoff" value="on" checked> On
                    <input type="radio" name="${date}_press_onoff" value="off"> Off
                </div>
                <div style="display:flex; alignitem:center; gap:5px">
                    <label style="margin-top:10px"><b>Due By:</b></label>
                    
                    <input type="date" name="${date}_press_date" class="form-control" style="width:150px; background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;"/>
                    <select name="${date}_press_hour" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateHourOptions()}</select>
                    <select name="${date}_press_minute" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateMinuteOptions()}</select>
                    <select name="${date}_press_period" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </div>
            </div>
        `;

      content.innerHTML += ` 
            <div style="display:flex; justify-content: space-between; align-items:center; background:white; padding:15px; border:1px solid lightgray">
                <h6><b>${date} - Pagination</b></h6>
                <div>
                    <input type="radio" name="${date}_pagination_onoff" value="on" checked> On
                    <input type="radio" name="${date}_pagination_onoff" value="off"> Off
                </div>
                <div style="display:flex; alignitem:center; gap:5px">
                    <label style="margin-top:10px"><b>Due By:</b></label>
                    
                    <input type="date" name="${date}_pagination_date" class="form-control" style="width:150px; background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;"/>
                    <select name="${date}_pagination_hour" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateHourOptions()}</select>
                    <select name="${date}_pagination_minute" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">${generateMinuteOptions()}</select>
                    <select name="${date}_pagination_period" style="background:white; border:1px solid lightgray; border-radius:5px; padding:5px 10px;">
                        <option>AM</option>
                        <option>PM</option>
                    </select>
                </div>
            </div>
        `;

      // Append the new content
      tabContent.appendChild(content);
    } else {
      // If the content already exists, show it
      content.style.display = 'block';
    }
  }

  function populateRateGroupContent(formId) {
    const unsignedRateGroupsField = document.getElementById('unsigned_rategroups').value;
    const validJsonData = unsignedRateGroupsField.replace(/'/g, '"');
    const unassigned_rategroups = validJsonData ? JSON.parse(validJsonData) : [];

    const availableOptions = unassigned_rategroups.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

    // Create content for the specific form
    const contentHTML = `
        <div class="item-select-container mgb-3 d-flex" id="rategroup-section-${formId}" style="display: none">
          <div class="available-pubs">
                <b>Available Rate Groups:</b><br />
                <select multiple="multiple" class="lstBox1 form-control" id="edit-pub-rategroup-${formId}-lstBox1" style="height: 250px; width: 250px;">
                    ${availableOptions}
                    </select>
            </div>
            <div class="transferBtns">
                <input type="button" class="btnRight-${formId}" value="  >  " />
                <br/><br />
                <input type="button" class="btnLeft-${formId}" value="  <  " />
            </div>
            <div class="selected-pubs">
              <b>Selected Rate Groups: </b><br />
              <select multiple="multiple" class="lstBox2 form-control" id="edit-pub-rategroup-${formId}-lstBox2" style="height: 250px; width: 250px;">
                </select>
                </div>
                </div>
                `;

    // Append this content to the container (or a parent element)
    const container = document.getElementById('rategroup_form_content');
    const formSection = document.createElement('div');
    formSection.innerHTML = contentHTML;
    container.appendChild(formSection);

    // Initialize the transfer button functionality after populating content
    initializeTransferButtons('rategroup', formId);
  }

  // Create Dynamically Ad Criteria Sections
  function populateAdCriteriaContent(formId) {
    const unsignedCriteriaField = document.getElementById('unsigned_criterias').value;
    const validJsonData = unsignedCriteriaField.replace(/'/g, '"');
    const unassigned_ciiterias = validJsonData ? JSON.parse(validJsonData) : [];

    const availableOptions = unassigned_ciiterias?.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

    // Create content for the specific form
    const contentHTML = `
        <div class="item-select-container mgb-3 d-flex" id="criteria-section-${formId}" style="display: none">
          <div class="available-pubs">
                <b>Available Ad Criteria:</b><br />
                <select multiple="multiple" class="lstBox1 form-control" id="edit-pub-criteria-${formId}-lstBox1" style="height: 250px; width: 250px;">
                    ${availableOptions}
                    </select>
            </div>
            <div class="transferBtns">
                <input type="button" class="btnRight-${formId}" value="  >  " />
                <br/><br />
                <input type="button" class="btnLeft-${formId}" value="  <  " />
            </div>
            <div class="selected-pubs">
              <b>Selected Ad Criteria: </b><br />
              <select multiple="multiple" class="lstBox2 form-control" id="edit-pub-criteria-${formId}-lstBox2" style="height: 250px; width: 250px;">
                </select>
                </div>
                </div>
                `;

    // Append this content to the container (or a parent element)
    const container = document.getElementById('criteria_form_content');
    const formSection = document.createElement('div');
    formSection.innerHTML = contentHTML;
    container.appendChild(formSection);

    // Initialize the transfer button functionality after populating content
    initializeTransferButtons('criteria', formId);
  }

  // Create Dynamically Adtype Sections
  function populateAdtypeContent(formId) {
    const unsignedAdtypeField = document.getElementById('unsigned_adtypes').value;
    const validJsonData = unsignedAdtypeField.replace(/'/g, '"');
    const unassigned_adtypes = validJsonData ? JSON.parse(validJsonData) : [];

    const availableOptions = unassigned_adtypes?.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

    // Create content for the specific form
    const contentHTML = `
        <div class="item-select-container mgb-3 d-flex" id="adtype-section-${formId}" style="display: none">
          <div class="available-pubs">
                <b>Available Ad Type:</b><br />
                <select multiple="multiple" class="lstBox1 form-control" id="edit-pub-adtype-${formId}-lstBox1" style="height: 250px; width: 250px;">
                    ${availableOptions}
                    </select>
            </div>
            <div class="transferBtns">
                <input type="button" class="btnRight-${formId}" value="  >  " />
                <br/><br />
                <input type="button" class="btnLeft-${formId}" value="  <  " />
            </div>
            <div class="selected-pubs">
              <b>Selected Ad Types: </b><br />
              <select multiple="multiple" class="lstBox2 form-control" id="edit-pub-adtype-${formId}-lstBox2" style="height: 250px; width: 250px;">
                </select>
                </div>
                </div>
                `;

    // Append this content to the container (or a parent element)
    const container = document.getElementById('adtype_form_content');
    const formSection = document.createElement('div');
    formSection.innerHTML = contentHTML;
    container.appendChild(formSection);

    initializeTransferButtons('adtype', formId);
  }

  // Create Dynamically Adjustments Sections
  function populateAdjustmentsContent(formId) {
    const unsignedAdjustmentField = document.getElementById('unsigned_adjustments').value;
    const validJsonData = unsignedAdjustmentField.replace(/'/g, '"');
    const unassigned_adjustments = validJsonData ? JSON.parse(validJsonData) : [];

    const availableOptions = unassigned_adjustments?.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

    // Create content for the specific form
    const contentHTML = `
        <div class="item-select-container mgb-3 d-flex" id="adjustment-section-${formId}" style="display: none">
          <div class="available-pubs">
                <b>Available Adjustments:</b><br />
                <select multiple="multiple" class="lstBox1 form-control" id="edit-pub-adjustment-${formId}-lstBox1" style="height: 250px; width: 250px;">
                    ${availableOptions}
                    </select>
            </div>
            <div class="transferBtns">
                <input type="button" class="btnRight-${formId}" value="  >  " />
                <br/><br />
                <input type="button" class="btnLeft-${formId}" value="  <  " />
            </div>
            <div class="selected-pubs">
              <b>Selected Adjustments: </b><br />
              <select multiple="multiple" class="lstBox2 form-control" id="edit-pub-adjustment-${formId}-lstBox2" style="height: 250px; width: 250px;">
                </select>
                </div>
                </div>
                `;

    // Append this content to the container (or a parent element)
    const container = document.getElementById('adjustment_form_content');
    const formSection = document.createElement('div');
    formSection.innerHTML = contentHTML;
    container.appendChild(formSection);

    initializeTransferButtons('adjustment', formId);
  }

  // Create Dynamically  Sections
  function populateSectionsContent(formId) {
    // Your assigned rate groups should be here (if any)
    const unsignedSectionsField = document.getElementById('unsigned_sections').value;
    const validJsonData = unsignedSectionsField.replace(/'/g, '"');
    const unassigned_sections = validJsonData ? JSON.parse(validJsonData) : [];

    const availableOptions = unassigned_sections?.map(item => `<option value="${item.id}">${item.name}</option>`).join('');

    // Create content for the specific form
    const contentHTML = `
        <div class="item-select-container mgb-3 d-flex" id="sections-section-${formId}" style="display: none">
          <div class="available-pubs">
                <b>Available Sections:</b><br />
                <select multiple="multiple" class="lstBox1 form-control" id="edit-pub-sections-${formId}-lstBox1" style="height: 250px; width: 250px;">
                    ${availableOptions}
                    </select>
            </div>
            <div class="transferBtns">
                <input type="button" class="btnRight-${formId}" value="  >  " />
                <br/><br />
                <input type="button" class="btnLeft-${formId}" value="  <  " />
            </div>
            <div class="selected-pubs">
              <b>Selected Sections: </b><br />
              <select multiple="multiple" class="lstBox2 form-control" id="edit-pub-sections-${formId}-lstBox2" style="height: 250px; width: 250px;">
                </select>
                </div>
                </div>
                `;

    // Append this content to the container (or a parent element)
    const container = document.getElementById('sections_form_content');
    const formSection = document.createElement('div');
    formSection.innerHTML = contentHTML;
    container.appendChild(formSection);

    initializeTransferButtons('sections', formId);
  }

  function initializeTransferButtons(type, formId) {
    const container = document.getElementById(`${type}-section-${formId}`);
    if (!container) return; // Ensure the container exists

    // Select the <select> elements using formId
    const lstBox1 = container.querySelector(`#edit-pub-${type}-${formId}-lstBox1`);
    const lstBox2 = container.querySelector(`#edit-pub-${type}-${formId}-lstBox2`);

    // Select the buttons using formId
    const btnRight = container.querySelector(`.btnRight-${formId}`);
    const btnLeft = container.querySelector(`.btnLeft-${formId}`);

    // Ensure buttons and listboxes exist before attaching event listeners
    if (btnRight && lstBox1 && lstBox2) {
      btnRight.addEventListener('click', () => {
        moveSelectedOptions(lstBox1, lstBox2);
      });
    }

    if (btnLeft && lstBox1 && lstBox2) {
      btnLeft.addEventListener('click', () => {
        moveSelectedOptions(lstBox2, lstBox1);
      });
    }
  }
  // Helper function to move selected options between lists

  function moveSelectedOptions(sourceList, targetList) {
    Array.from(sourceList.selectedOptions).forEach(option => {
      targetList.appendChild(option);
    });
  }
  // Assuming you have tab buttons with IDs like 'tab1', 'tab2', etc.

  function switchTab(tabIndex) {
    // Hide all Rate Group sections

    const allRategroupSections = document.querySelectorAll('[id^="rategroup-section-"]');
    allRategroupSections?.forEach(section => {
      section.style.display = 'none';
    });

    // Show the selected form's Rate Group section
    const selectedRategroup = document.getElementById(`rategroup-section-${tabIndex}`);
    if (selectedRategroup) {
      selectedRategroup.style.display = 'flex';
    }

    const allCriteriaSections = document.querySelectorAll('[id^="criteria-section-"]');
    allCriteriaSections?.forEach(section => {
      section.style.display = 'none';
    });

    // Show the selected form's Rate Group section
    const selectedCriteria = document.getElementById(`criteria-section-${tabIndex}`);
    if (selectedCriteria) {
      selectedCriteria.style.display = 'flex';
    }

    const allAdtypeSections = document.querySelectorAll('[id^="adtype-section-"]');
    allAdtypeSections?.forEach(section => {
      section.style.display = 'none';
    });

    const selectedAdtypeSection = document.getElementById(`adtype-section-${tabIndex}`);
    if (selectedAdtypeSection) {
      selectedAdtypeSection.style.display = 'flex';
    }

    const allAdjustmentSections = document.querySelectorAll('[id^="adjustment-section-"]');
    allAdjustmentSections?.forEach(section => {
      section.style.display = 'none';
    });

    const selectedAdjustmentSection = document.getElementById(`adjustment-section-${tabIndex}`);
    if (selectedAdjustmentSection) {
      selectedAdjustmentSection.style.display = 'flex';
    }

    const allSections = document.querySelectorAll('[id^="sections-section-"]');
    allSections?.forEach(section => {
      section.style.display = 'none';
    });

    const selectedSection = document.getElementById(`sections-section-${tabIndex}`);
    if (selectedSection) {
      selectedSection.style.display = 'flex';
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const repeatRadio = document.getElementById('calendar-radio-one');
    const nonRepeatRadio = document.getElementById('calendar-radio-two');

    const sections = [
      { repeat: '.repeating-calendar', nonRepeat: '.non-repeating' },
      { repeat: '.repeat-deadlines-container', nonRepeat: '.product-deadlines-container' },
      { repeat: '.repeat_rategroup_section', nonRepeat: '.product_rategroups_container' },
      { repeat: '.repeat_adtype_section', nonRepeat: '.product_adtype_container' },
      { repeat: '.repeat_adjustment_section', nonRepeat: '.product_adjustment_container' },
      { repeat: '.repeat_section_container', nonRepeat: '.product_section_container' },
      { repeat: '.repeat_criteria_section', nonRepeat: '.product_criteria_container' }
    ];

    function toggleSections(activeType) {
      sections.forEach(({ repeat, nonRepeat }) => {
        document.querySelector(repeat).classList.toggle('active', activeType === 'repeat');
        document.querySelector(repeat).classList.toggle('hide', activeType !== 'repeat');
        document.querySelector(nonRepeat).classList.toggle('active', activeType === 'nonRepeat');
        document.querySelector(nonRepeat).classList.toggle('hide', activeType !== 'nonRepeat');
      });
    }

    // Set initial state based on which radio is checked
    const initialType = repeatRadio.checked ? 'repeat' : 'nonRepeat';

    const elements = document.getElementsByClassName('repeat_status');
    if (repeatRadio?.checked) {
      for (let element of elements) {
        element.innerHTML = '';
        element.innerHTML = 'Repeat';
      }
    } else {
      for (let element of elements) {
        element.innerHTML = '';
        element.innerHTML = 'Non Repeat';
      }
    }

    toggleSections(initialType);

    repeatRadio.addEventListener('change', () => {
      if (repeatRadio.checked) {
        toggleSections('repeat');
        $.toastr.success('Repeat Schedule Selected');
        for (let element of elements) {
          element.innerHTML = 'Repeat';
        }
      }
    });

    nonRepeatRadio.addEventListener('change', () => {
      if (nonRepeatRadio.checked) {
        toggleSections('nonRepeat');
        $.toastr.success('Non Repeat Schedule Selected');

        for (let element of elements) {
          element.innerHTML = 'Non Repeat';
        }
      }
    });
  });
</script>

<script>
  //Step Form
  var currentTab = 0; // Current tab is set to be the first tab (0)
  showTab(currentTab); // Display the current tab

  function showTab(n) {
    // This function will display the specified tab of the form...
    var x = document.getElementsByClassName('tab');
    x[n].style.display = 'block';
    //... and fix the Previous/Next buttons:
    if (n == 0) {
      document.getElementById('prevBtn').style.display = 'none';
    } else {
      document.getElementById('prevBtn').style.display = 'inline';
    }
    if (n == x.length - 1) {
      document.getElementById('nextBtn').innerHTML = 'Submit';
    } else {
      document.getElementById('nextBtn').innerHTML = 'Next';
    }
    //... and run a function that will display the correct step indicator:
    fixStepIndicator(n);
    //fixMobileStepIndicator(n);
  }

  function nextPrev(n) {
    // This function will figure out which tab to display
    var x = document.getElementsByClassName('tab');
    // Going backwards? Remove 'finish' from current step
    if (n === -1) {
      var steps = document.getElementsByClassName('step');
      steps[currentTab].classList.remove('finish');
    }

    // Exit the function if any field in the current tab is invalid:
    //if (n == 1 && !validateForm()) return false;
    // Hide the current tab:
    x[currentTab].style.display = 'none';
    // Skip field validation, but still mark step as finished
    document.getElementsByClassName('step')[currentTab].classList.add('finish');

    // Increase or decrease the current tab by 1:
    currentTab = currentTab + n;
    // if you have reached the end of the form...
    if (currentTab >= x.length) {
      // ... the form gets submitted:
      document.getElementById('').submit();
      return false;
    }
    // Otherwise, display the correct tab:
    showTab(currentTab);
  }

  function validateForm() {
    // This function deals with validation of the form fields
    var x,
      y,
      i,
      valid = true;
    x = document.getElementsByClassName('tab');
    y = x[currentTab].getElementsByTagName('input');
    // A loop that checks every input field in the current tab:
    for (i = 0; i < y.length; i++) {
      // If a field is empty...
      if (y[i].value == '') {
        // add an "invalid" class to the field:
        y[i].className += ' invalid';
        // and set the current valid status to false
        valid = false;
      }
    }
    // If the valid status is true, mark the step as finished and valid:
    if (valid) {
      document.getElementsByClassName('step')[currentTab].className += ' finish';
    }
    return valid; // return the valid status
  }

  function fixStepIndicator(n) {
    // This function removes the "active" class of all steps...
    var i,
      x = document.getElementsByClassName('step');
    for (i = 0; i < x.length; i++) {
      x[i].className = x[i].className.replace(' active', '');
    }
    //... and adds the "active" class on the current step:
    x[n].className += ' active';
  }

  // function fixMobileStepIndicator(n) {
  //   // This function removes the "active" class of all steps...
  //   var i,
  //     x = document.getElementsByClassName('mobile-step');
  //   for (i = 0; i < x.length; i++) {
  //     x[i].className = x[i].className.replace(' active', '');
  //   }
  //   //... and adds the "active" class on the current step:
  //   x[n].className += ' active';
  // }
</script>

{% endblock%}
